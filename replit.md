# DirectTransports - Transportation Quote SaaS

## Overview

DirectTransports is a B2B SaaS application for calculating transportation quotes based on route distance, vehicle type, and zone-based pricing rules. The system integrates with OpenRouteService for real-time distance calculation and provides administrators with tools to manage pricing zones, vehicle types, and quote history.

**Core Value Proposition**: Automated quote generation using real-world routing data, eliminating manual distance estimation and pricing calculation errors.

**Tech Stack Summary**:
- Frontend: React + TypeScript with Vite
- Backend: Express + TypeScript
- Database: PostgreSQL via Neon with Drizzle ORM
- Routing API: OpenRouteService
- UI Framework: shadcn/ui with Tailwind CSS

## User Preferences

- Preferred communication style: Simple, everyday language
- Language: Spanish (todo en español)
- Features: Dark/light theme toggle (activated), Dashboard shows 0 values (pre-launch state)
- Architecture: Role-based access control (admin vs customer)
- Admin name: Daniel (email: daniel@directtransports.com)
- App name: DirectTransports
- Pricing model: Price per km + minimum price (no base/direction charges)
- Urgency option: 25% surcharge available in calculator

## System Architecture

### Application Structure

**Monorepo Organization**:
- `/client` - React SPA frontend
- `/server` - Express REST API backend  
- `/shared` - Shared TypeScript schemas and types (Drizzle schemas, Zod validators)
- `/migrations` - Database migrations generated by Drizzle Kit

**Rationale**: Sharing type definitions between client and server ensures type safety across the API boundary and reduces duplication. The monorepo structure simplifies development and deployment.

### Frontend Architecture

**Role-Based Access Control (RBAC)**:
- Two user roles: `admin` and `customer`
- Separate routers for each role with protected access
- AdminRouter: Dashboard, Pricing Rules, Vehicle Types
- CustomerRouter: Quote Calculator, History, Contact

**Admin Area** (Protected):
- `/` - Dashboard (0 values - pre-launch)
- `/admin/pricing` - Manage pricing rules
- `/admin/vehicles` - Manage vehicle types with on/off toggle

**Customer Area** (Protected):
- `/` - Quote calculator with urgency option (+25%)
- `/history` - Quote history
- `/contact` - Contact information

**React SPA with Client-Side Routing**:
- Uses Wouter for lightweight routing
- Context-based state management (AuthContext, ThemeContext)
- React Query (TanStack Query) for server state management
- Form handling via React Hook Form with Zod validation
- ProtectedRoute component enforces role-based access

**Component Philosophy**:
- shadcn/ui components provide accessible, customizable primitives
- Business components built on top of UI primitives
- Design system inspired by Linear and [REDACTED-STRIPE] (clean, data-focused)
- Custom theming via CSS variables for light/dark mode support

**Key Design Decisions**:
- **Role-based routing**: AdminRouter and CustomerRouter are completely separate, preventing customer access to admin areas
- **ProtectedRoute component**: Validates user role before rendering content
- **No global state library**: React Query handles server state, Context API handles auth/theme/role
- **Composition over configuration**: Components are copied into codebase (shadcn pattern)
- **Type-safe API calls**: Shared schemas ensure frontend and backend agree on data structures
- **localStorage persistence**: User role persists across page reloads

### Backend Architecture

**Express REST API**:
- TypeScript for type safety
- Session-based authentication with mock admin user (Daniel)
- RESTful endpoints for CRUD operations on pricing rules, vehicle types, and quotes
- Role information stored in session (not yet persisted, currently mock)

**Service Layer**:
- `openrouteservice.ts` - External API integration for geocoding and routing
- `storage.ts` - Data access abstraction (in-memory mock with plans for database implementation)

**Key Design Decisions**:
- **Service abstraction**: `IStorage` interface allows swapping between in-memory and database implementations
- **Memoization potential**: Distance calculations can be cached since routes rarely change
- **Error handling**: API errors are caught and returned with appropriate HTTP status codes

### Database Design

**Schema (Drizzle ORM)**:

**Users Table** (Future):
- Authentication and authorization
- `role` field for admin/customer distinction

**Pricing Rules Table** (Future):
- Zone-based pricing configuration
- Fields: zone number, country, distance range (min/max km), price per km, toll surcharge, minimum price
- Supports multiple countries (España, Portugal, Francia)
- `isActive` flag for soft deletion

**Vehicle Types Table**:
- Vehicle configurations with capacity information
- Fields: name, description, capacity, pricePerKm, minimumPrice, isActive
- No basePrice field - pricing is purely distance-based
- Current types: Moto, Furgoneta, Furgón, Carrozado
- Soft delete via `isActive` flag (toggle on/off without data loss)

**Quotes Table**:
- Historical quote storage
- Fields: origin/destination addresses, coordinates, distance, duration, pricing breakdown, selected vehicle, final price, isUrgent
- Status tracking (pending, accepted, rejected)
- User association for history viewing

**Design Rationale**:
- Pricing rules are configurable rather than hardcoded
- Storing full quote details enables auditing and analytics
- Soft deletion via `isActive` preserves historical data
- Urgency flag tracks if 25% surcharge was applied

### Authentication Strategy

**Current Implementation**: Mock authentication
- Default user: Daniel (admin role)
- Authentication system ready for Replit Auth integration
- Role-based route access enforced client-side
- User role persisted in localStorage

**Planned Implementation**: Replit Auth + Database session store
- OAuth-based authentication
- Session management via `express-session` with PostgreSQL session store (`connect-pg-simple`)
- Role-based access: regular users can create quotes, admins can modify pricing rules and vehicle types

**Rationale**: OAuth simplifies user management (no password storage) and Replit Auth integrates seamlessly with the Replit deployment environment.

### Quote Calculation Logic

**Multi-Step Process**:

1. **Geocoding**: Convert origin/destination addresses to coordinates via OpenRouteService
2. **Route Calculation**: Get actual driving distance and duration
3. **Vehicle Selection**: Operator selects from active vehicles only
4. **Price Calculation**:
   - Distance cost = distance × price per km
   - Base amount = max(minimumPrice, distance cost)
   - If urgent: base amount × 1.25 (25% surcharge)
   - Apply minimum price threshold

**Design Rationale**:
- Using actual routing API eliminates "as the crow flies" distance errors
- No base/direction charges - purely distance-based pricing
- Urgency surcharge allows customers to request expedited delivery
- Vehicle-specific minimum ensures profitability for all vehicle types

### API Integration

**OpenRouteService**:
- Geocoding API: Address → coordinates + country detection
- Directions API: Route calculation with distance/duration
- API key stored in ORS_API_KEY environment variable

**Error Handling**:
- Invalid addresses return user-friendly error messages
- API rate limits are handled gracefully (though not currently implemented)
- Failed geocoding suggests address corrections

**Future Consideration**: Caching geocoding results and route distances for frequently requested routes could reduce API costs.

## External Dependencies

### Core Infrastructure

**Database**: 
- PostgreSQL (via Neon serverless)
- Drizzle ORM for type-safe queries
- Database URL configured via `DATABASE_URL` environment variable

**Session Store**: 
- `connect-pg-simple` stores Express sessions in PostgreSQL
- Enables horizontal scaling without sticky sessions

### Third-Party APIs

**OpenRouteService**:
- Purpose: Geocoding and route calculation
- API key: `ORS_API_KEY` environment variable
- Base URL: `https://api.openrouteservice.org`
- Endpoints used:
  - `/geocode/search` - Address to coordinates
  - `/v2/directions/driving-car` - Route with distance/duration

### UI & Styling

**shadcn/ui**:
- Radix UI primitives for accessibility
- Tailwind CSS for styling
- Component library copied into project for full control

**Fonts**:
- Inter (via Google Fonts) for UI text
- JetBrains Mono for numerical data and code
- Loaded via CDN in `index.html`

**Theme System**:
- Light/dark mode toggle via ThemeContext
- localStorage persistence of theme preference
- System preference detection as fallback
- CSS variables for semantic colors

### Development Tools

**Vite**:
- Development server with HMR
- Build tool for production bundle
- Replit-specific plugins for debugging and deployment

**ESBuild**:
- Server-side bundling for production
- Selective bundling of dependencies to reduce cold start times

**TypeScript**:
- Strict mode enabled
- Shared types between client/server via path aliases

### Authentication (Planned)

**Replit Auth**:
- OAuth provider integration
- No additional API keys required when deployed on Replit
- Falls back to mock auth in development

### Package Management

**Key Dependencies**:
- `@tanstack/react-query` - Server state management
- `react-hook-form` + `zod` - Type-safe form validation
- `drizzle-orm` + `drizzle-zod` - Database ORM with Zod integration
- `wouter` - Lightweight routing
- `express-session` - Session management

**Build Tools**:
- `tsx` - TypeScript execution for development
- `esbuild` - Production server bundling
- `drizzle-kit` - Database migration tool

## Recent Changes (v2.2 - Pricing & Urgency Updates)

### 2025-11-30 Pricing Model Refactor

**Removed**:
- `basePrice` field from vehicle types table
- "Dirección" column from admin vehicle management table
- Base pricing UI from vehicle configuration dialog

**Added**:
- Urgency option in quote calculator (+25% surcharge)
- `isUrgent` field in quotes table
- Urgency indicator in quote breakdown display
- Method to show urgency surcharge calculation

**Modified**:
- Quote calculation: now uses only (distance × pricePerKm) vs minimumPrice
- Vehicle types table: shows only €/Km and Mínimo columns
- Quote results display: shows distance breakdown and urgency status
- Admin vehicle form: reduced to pricePerKm and minimumPrice only

**Fixed**:
- Removed confusing base/direction pricing
- Aligned pricing model with actual business operations
- Simplified calculation logic for clarity

**Rationale for Changes**:
- Client operates on distance-based pricing only
- Base pricing was unnecessary overhead
- Urgency feature provides flexibility for premium deliveries
- Cleaner UI reduces admin configuration burden

